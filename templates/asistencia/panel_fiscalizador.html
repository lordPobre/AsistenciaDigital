{% extends 'base.html' %}
{% load l10n %}

{% block content %}
<div class="container mt-4">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0 fw-bold">
                <i class="fas fa-balance-scale text-primary me-2"></i>Fiscalización DT
            </h2>
            <div class="text-muted mt-1">
                Empresa Auditada: <span class="text-dark fw-bold">{{ empresa.nombre|upper }}</span> |
                RUT: {{ empresa.rut }}
            </div>
        </div>
        <div class="mt-3 mt-md-0">
            <span class="badge bg-primary fs-6 shadow-sm">Vista Oficial de Auditoría</span>
        </div>
    </div>

    <form method="GET" class="card p-3 shadow-sm border-0 mb-4 bg-light">
        <div class="row g-3 align-items-end">
            <div class="col-6 col-md-3">
                <label class="form-label fw-bold text-muted small text-uppercase mb-1">Desde</label>
                <input type="date" name="desde" value="{{ desde }}" class="form-control shadow-sm" required>
            </div>

            <div class="col-6 col-md-3">
                <label class="form-label fw-bold text-muted small text-uppercase mb-1">Hasta</label>
                <input type="date" name="hasta" value="{{ hasta }}" class="form-control shadow-sm" required>
            </div>

            <div class="col-12 col-md-6">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary shadow-sm fw-bold text-white">
                        <i class="fas fa-filter me-2"></i> Filtrar
                    </button>

                    <button type="submit" formaction="{% url 'exportar_reporte_fiscalizacion' %}" class="btn btn-success shadow-sm fw-bold text-white" title="Descargar Reporte Técnico CSV/Excel">
                        <i class="fas fa-file-csv me-2"></i> Reporte DT
                    </button>

                    <a href="{{ request.path }}" class="btn btn-light bg-white border shadow-sm text-muted" title="Limpiar Filtros">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </form>

    <div class="card shadow border-0 d-none d-md-block">
        <div class="card-header bg-dark text-white py-3">
            <h6 class="m-0 fw-bold"><i class="fas fa-list-alt me-2"></i>Registro de Asistencia (Calculado)</h6>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Trabajador</th>
                        <th>Fecha</th>
                        <th class="text-success">Entrada</th>
                        <th class="text-danger">Salida</th>
                        <th>Duración</th>
                        <th class="text-center">Cumplimiento</th>
                    </tr>
                </thead>
                <tbody>
                    {% for j in jornadas %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ j.trabajador.get_full_name }}</div>
                            <small class="text-muted">{{ j.trabajador.perfil.rut }}</small>
                        </td>
                        <td>
                            {{ j.fecha|date:"d/m/Y" }}
                        </td>

                        <td>
                            {% if j.entrada %}
                                <span class="fw-bold text-success">{{ j.entrada|date:"H:i" }}</span>
                            {% else %}
                                <span class="text-muted small fst-italic">--:--</span>
                            {% endif %}
                        </td>

                        <td>
                            {% if j.salida %}
                                <span class="fw-bold text-danger">{{ j.salida|date:"H:i" }}</span>
                            {% else %}
                                <span class="text-muted small fst-italic">--:--</span>
                            {% endif %}
                        </td>

                        <td>
                            <span class="fw-bold text-dark bg-light px-2 py-1 rounded border">
                                {{ j.duracion }}
                            </span>
                        </td>

                        <td class="text-center">
                            {% if j.estado == 'success' %}
                                <span class="badge bg-success"><i class="fas fa-check me-1"></i> OK</span>
                            {% elif j.estado == 'info' %}
                                <span class="badge bg-info text-dark">En Curso</span>
                            {% elif j.estado == 'warning' %}
                                <span class="badge bg-warning text-dark">Incompleto</span>
                            {% else %}
                                <span class="badge bg-danger">Inconsistencia</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-folder-open fa-3x text-muted mb-3 opacity-50"></i>
                            <p class="text-muted fw-bold">No hay registros de jornadas en el rango seleccionado.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="d-md-none">
        {% for j in jornadas %}
        <div class="card mb-3 shadow-sm border-0 rounded-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-0 fw-bold">{{ j.trabajador.get_full_name }}</h5>
                        <small class="text-muted">{{ j.trabajador.perfil.rut }}</small>
                    </div>
                    <div class="text-end">
                        <small class="d-block fw-bold text-muted">{{ j.fecha|date:"d M" }}</small>

                        {% if j.estado == 'success' %}
                            <i class="fas fa-check-circle text-success fs-5"></i>
                        {% elif j.estado == 'danger' %}
                            <i class="fas fa-exclamation-circle text-danger fs-5"></i>
                        {% else %}
                            <i class="fas fa-clock text-warning fs-5"></i>
                        {% endif %}
                    </div>
                </div>

                <div class="row g-0 text-center bg-light rounded-3 overflow-hidden border">
                    <div class="col-6 border-end p-2">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Entrada</small>
                        <div class="fw-bold text-success fs-5">
                            {{ j.entrada|date:"H:i"|default:"--:--" }}
                        </div>
                    </div>
                    <div class="col-6 p-2">
                        <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Salida</small>
                        <div class="fw-bold text-danger fs-5">
                            {{ j.salida|date:"H:i"|default:"--:--" }}
                        </div>
                    </div>
                </div>

                <div class="mt-3 text-center border-top pt-2">
                    <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Total Jornada</small>
                    <span class="fw-bold text-dark d-block fs-6">{{ j.duracion }}</span>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="alert alert-info text-center rounded-3 shadow-sm border-0">
            No hay registros para mostrar.
        </div>
        {% endfor %}
    </div>

</div>
{% endblock %}
